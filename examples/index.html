<!DOCTYPE html>
<html>
<head>
<style>
  .ace_editor {
    width: 800px;
    height: 600px;
  }
</style>
<link rel="stylesheet" type="text/css" href="/share-ace.css">
<script src="/channel/bcsocket.js"></script>
<script src="/share.uncompressed.js"></script>
<script src="/share-ace.js"></script>
<script src="/share-ace-cursor.js"></script>
<script src='/ace-builds/src-noconflict/ace.js'></script>
<script src='/ace-builds/src-noconflict/ext-modelist.js'></script>
</head>
<body>
<div id="pad">Connecting...</div>
<button id="monkey">Infinite Monkey</button>
<script>

var Range = ace.require('ace/range').Range;
var editor = ace.edit('pad');
editor.setTheme("ace/theme/monokai");
editor.$blockScrolling = Infinity;

var s = new BCSocket(null, {reconnect: true});
var sjs = new window.sharejs.Connection(s);
var doc = sjs.get('collection', 'doc');

doc.subscribe();
doc.whenReady(function () {
  if (!doc.type) doc.create('text');
  if (doc.type && doc.type.name === 'text') {
    doc.attachAceEditor(editor.getSession());
    doc.attachAceEditorCursor(editor.getSession());
  }
});

document.getElementById('monkey').onclick = function() {
  setInterval(monkeyType, 500);
};


function monkeyType() {
  var textLength = editor.getValue().length;
  var pos = Math.floor(Math.random()*textLength);
  var from = editor.getSession().getDocument().indexToPosition(pos);
  var editLength = randomInt(20)
  if(Math.random() < 0.6) {
    // Add text
    var text =  randomString(editLength);
    var start = editor.getSession().getDocument().indexToPosition(pos);
    var end = editor.getSession().getDocument().indexToPosition(pos+text.length);
    editor.getSession().getSelection().moveCursorToPosition(start);
    editor.getSession().insert(start, text);
    editor.getSession().getSelection().setSelectionRange(new Range(start.row, start.column, end.row, end.column));
  } else {
    var endIndex = Math.min(pos + editLength, textLength-1);
    var to = editor.getSession().getDocument().indexToPosition(endIndex);
    editor.getSession().remove({start: from, end: to });
  }
}

function randomString(len) {
	var chars = "0123456789 ABCDEF GHIJKLM NOPQRSTUVWXTZ\nabcde\nfghiklmnop\nqrstuvwxyz";
	var result = '';
	for (var i=0; i<len; i++) {
		var rnum = randomInt(chars.length);
		result += chars.substring(rnum, rnum+1);
	}
  return result;
}

function randomInt(max) {
  return Math.floor(Math.random()*max);
}

</script>
</body>
</html>
